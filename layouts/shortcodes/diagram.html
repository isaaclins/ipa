{{- /*
  Diagram Shortcode - Mermaid and UML Diagram Support
  
  Usage:
    {{< diagram >}}
    graph TD
        A[Start] --> B[End]
    {{< /diagram >}}
  
    {{< diagram type="sequence" caption="Authentication Flow" >}}
    sequenceDiagram
        User->>Server: Login
        Server-->>User: Token
    {{< /diagram >}}
  
  Features:
  - Supports Mermaid diagram syntax
  - Auto figure numbering for diagrams
  - Support for captions
  - Fallback for PDF generation (pre-rendered images)
  - Support for custom IDs
  
  Parameters:
  - type: Diagram type hint (optional, for documentation)
  - caption: Diagram caption (optional)
  - id: Custom anchor ID (optional)
  - class: Additional CSS classes (optional)
*/ -}}

{{- /* Initialize global diagram counter if not exists */ -}}
{{- if not (.Page.Scratch.Get "diagramCounter") -}}
  {{- .Page.Scratch.Set "diagramCounter" 0 -}}
{{- end -}}

{{- /* Increment diagram counter */ -}}
{{- $diagNum := add (.Page.Scratch.Get "diagramCounter") 1 -}}
{{- .Page.Scratch.Set "diagramCounter" $diagNum -}}

{{- /* Get parameters */ -}}
{{- $type := .Get "type" | default "mermaid" -}}
{{- $caption := .Get "caption" | default "" -}}
{{- $id := .Get "id" | default (printf "diagram-%d" $diagNum) -}}
{{- $class := .Get "class" | default "" -}}

{{- /* Get diagram content */ -}}
{{- $content := .Inner | safeHTML -}}

<figure id="{{ $id }}" class="diagram {{ $class }}" data-diagram-type="{{ $type }}">
  {{/* Mermaid diagram - renders client-side in browser */}}
  <div class="mermaid diagram-content">
{{ $content }}
  </div>
  
  {{/* Pre-rendered fallback for PDF (check if image exists) */}}
  {{- $fallbackPath := printf "/images/diagrams/%s.svg" $id -}}
  {{- if fileExists (printf "static%s" $fallbackPath) -}}
  <noscript>
    <img src="{{ $fallbackPath | absURL }}" alt="{{ $caption | default "Diagram" }}" class="diagram-fallback">
  </noscript>
  {{- end -}}
  
  {{ with $caption }}
  <figcaption>
    <span class="diagram-label">Diagramm {{ $diagNum }}:</span>
    <span class="diagram-caption">{{ . }}</span>
  </figcaption>
  {{ end }}
</figure>
