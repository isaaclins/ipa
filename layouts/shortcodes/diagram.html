{{- /*
  Diagram Shortcode - Mermaid Diagram Support
  
  Usage:
    {{< diagram >}}
    graph TD
        A[Start] --> B[End]
    {{< /diagram >}}
  
    {{< diagram caption="Authentication Flow" >}}
    sequenceDiagram
        User->>Server: Login
        Server-->>User: Token
    {{< /diagram >}}
  
  Features:
  - Supports Mermaid diagram syntax
  - Auto figure numbering for diagrams
  - Support for captions
  - Renders in browser (no pre-rendering needed)
  
  Parameters:
  - caption: Diagram caption (optional)
  - id: Custom anchor ID (optional)
  - class: Additional CSS classes (optional)
*/ -}}

{{- /* Initialize global diagram counter if not exists */ -}}
{{- if not (.Page.Scratch.Get "diagramCounter") -}}
  {{- .Page.Scratch.Set "diagramCounter" 0 -}}
{{- end -}}

{{- /* Increment diagram counter */ -}}
{{- $diagNum := add (.Page.Scratch.Get "diagramCounter") 1 -}}
{{- .Page.Scratch.Set "diagramCounter" $diagNum -}}

{{- /* Get parameters */ -}}
{{- $caption := .Get "caption" | default "" -}}
{{- $id := .Get "id" | default (printf "diagram-%d" $diagNum) -}}
{{- $class := .Get "class" | default "" -}}

{{- /* Get diagram content - trim whitespace */ -}}
{{- $content := .Inner | safeHTML -}}

<figure id="{{ $id }}" class="diagram {{ $class }}">
  <pre class="mermaid">
{{- $content -}}
  </pre>
  {{ with $caption }}
  <figcaption>
    <span class="diagram-label">Diagramm {{ $diagNum }}:</span>
    <span class="diagram-caption">{{ . }}</span>
  </figcaption>
  {{ end }}
</figure>
