{{- /*
  PDF Layout - Full Document for Browser Print
  
  This layout combines ALL content into a single printable HTML document.
  Use browser's File > Print (Ctrl+P / Cmd+P) to save as PDF.
  
  Features:
  - Mermaid diagrams render before print
  - Print button waits for all content to load
  - Images fully supported
  
  Structure:
  1. Titelblatt (Title Page)
  2. Table of Contents
  3. All Parts/Chapters (numbered)
  4. Arbeitsjournal
  5. Glossar
*/ -}}

<!DOCTYPE html>
<html lang="{{ .Site.LanguageCode | default "de-ch" }}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ .Site.Params.thema | default .Site.Title }} - PDF</title>
  <link rel="stylesheet" href="{{ "css/main.css" | absURL }}">
  <link rel="stylesheet" href="{{ "css/pdf.css" | absURL }}">
  
  {{/* Mermaid.js for diagram rendering */}}
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  
  <style>
    /* Print button - hidden when printing */
    .print-controls {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .print-btn {
      background: #000000;
      color: white;
      border: none;
      padding: 12px 24px;
      font-family: monospace;
      font-size: 16px;
      font-weight: 600;
      border-radius: 0;
      cursor: pointer;
      box-shadow: none;
      border: 1px solid #000000;
      transition: all 0.2s;
    }
    
    .print-btn:hover {
      background: #595959;
      border-color: #595959;
    }
    
    .print-btn:disabled {
      background: #595959;
      border-color: #595959;
      cursor: wait;
    }
    
    .print-status {
      background: white;
      padding: 8px 16px;
      border-radius: 0;
      font-family: monospace;
      font-size: 14px;
      border: 1px solid #000000;
    }
    
    @media print {
      .print-controls {
        display: none !important;
      }
    }
  </style>
</head>
<body class="pdf-document">

{{/* Print Controls */}}
<div class="print-controls">
  <span class="print-status" id="printStatus">Diagramme werden geladen...</span>
  <button class="print-btn" id="printBtn" disabled onclick="window.print()">
    ðŸ“„ Als PDF speichern
  </button>
</div>

{{/* ========== TITELBLATT ========== */}}
<section id="titelblatt" class="titelblatt pdf-section">
  <div class="titelblatt-content">
    <div class="titelblatt-header">
      <h1 class="document-type">Individuelle Praktische Arbeit</h1>
    </div>
    
    <div class="titelblatt-title">
      <h1 class="ipa-title">{{ .Site.Params.thema | default .Site.Title }}</h1>
    </div>
    
    <div class="titelblatt-meta">
      <table class="meta-table">
        <tr><th>Autor:</th><td>{{ .Site.Params.autor }}</td></tr>
        <tr><th>Firma:</th><td>{{ .Site.Params.firma }}</td></tr>
        <tr><th>Abteilung:</th><td>{{ .Site.Params.abteilung }}</td></tr>
        <tr><th>Berufsschule:</th><td>{{ .Site.Params.berufsschule }}</td></tr>
        <tr><th>Validexperte (VEX):</th><td>{{ .Site.Params.validexperte }}</td></tr>
        <tr><th>Hauptexperte (HEX):</th><td>{{ .Site.Params.hauptexperte }}</td></tr>
        <tr><th>Nebenexperte (NEX):</th><td>{{ .Site.Params.nebenexperte }}</td></tr>
        <tr><th>Verantwortliche Fachkraft (VF):</th><td>{{ .Site.Params.verantwortlicheFachkraft }}</td></tr>
        <tr><th>Berufsbildner:</th><td>{{ .Site.Params.berufsbildner }}</td></tr>
        <tr><th>Fachrichtung:</th><td>{{ .Site.Params.fachrichtung }}</td></tr>
        <tr><th>Projektvorgehensmodell:</th><td>{{ .Site.Params.projektvorgehensmodell }}</td></tr>
        <tr><th>Jahrgang und Kanton:</th><td>{{ .Site.Params.jahrgangKanton }}</td></tr>
        <tr><th>Ausgabedatum:</th><td>{{ .Site.Params.ausgabedatum }}</td></tr>
        <tr><th>Datum:</th><td>{{ .Site.Params.datumVon }} - {{ .Site.Params.datumBis }}</td></tr>
        <tr><th>Version:</th><td>{{ .Site.Params.version }}</td></tr>
      </table>
    </div>
  </div>
</section>

{{/* ========== TABLE OF CONTENTS ========== */}}
<section id="toc" class="toc pdf-section">
  <h1>Inhaltsverzeichnis</h1>
  <nav class="toc-content">
    {{- $chapterNum := 0 -}}
    {{- range .Site.Sections -}}
      {{- if and (not (eq .Section "pdf")) (not (eq .Section "glossar")) (not (eq .Section "arbeitsjournal")) -}}
        {{- $chapterNum = add $chapterNum 1 -}}
        <div class="toc-chapter">
          <a href="#{{ .Section }}" class="toc-chapter-link">
            <span class="toc-num">{{ $chapterNum }}.</span>
            <span class="toc-title">{{ .Title }}</span>
          </a>
          {{- if .Pages -}}
          <ul class="toc-subchapters">
            {{- range $subNum, $page := .Pages.ByWeight -}}
            <li>
              <a href="#{{ $page.File.ContentBaseName }}">
                <span class="toc-num">{{ $chapterNum }}.{{ add $subNum 1 }}</span>
                <span class="toc-title">{{ $page.Title }}</span>
              </a>
            </li>
            {{- end -}}
          </ul>
          {{- end -}}
        </div>
      {{- end -}}
    {{- end -}}
    
    {{/* Arbeitsjournal in TOC */}}
    {{- with .Site.GetPage "/arbeitsjournal" -}}
    <div class="toc-chapter">
      <a href="#arbeitsjournal" class="toc-chapter-link">
        <span class="toc-title">Arbeitsjournal</span>
      </a>
    </div>
    {{- end -}}
    
    {{/* Glossar in TOC */}}
    {{- with .Site.GetPage "/glossar" -}}
    <div class="toc-chapter">
      <a href="#glossar" class="toc-chapter-link">
        <span class="toc-title">Glossar</span>
      </a>
    </div>
    {{- end -}}
  </nav>
</section>

{{/* ========== MAIN CONTENT - ALL PARTS ========== */}}
{{- $chapterNum := 0 -}}
{{- range .Site.Sections -}}
  {{- if and (not (eq .Section "pdf")) (not (eq .Section "glossar")) (not (eq .Section "arbeitsjournal")) -}}
    {{- $chapterNum = add $chapterNum 1 -}}
    
    {{/* Chapter Title Page */}}
    <section id="{{ .Section }}" class="chapter pdf-section">
      <div class="chapter-title-page">
        <div class="chapter-number">
          <span class="chapter-label">Kapitel</span>
          <span class="chapter-num">{{ $chapterNum }}</span>
        </div>
        <h1 class="chapter-title">{{ .Title }}</h1>
        {{ with .Description }}
        <p class="chapter-description">{{ . }}</p>
        {{ end }}
      </div>
      
      {{ with .Content }}
      <div class="chapter-intro">
        {{ . }}
      </div>
      {{ end }}
    </section>
    
    {{/* Subchapters */}}
    {{- range $subNum, $page := .Pages.ByWeight -}}
    <section id="{{ $page.File.ContentBaseName }}" class="subchapter pdf-section">
      <header class="subchapter-header">
        <div class="subchapter-number">{{ $chapterNum }}.{{ add $subNum 1 }}</div>
        <h2 class="subchapter-title">{{ $page.Title }}</h2>
      </header>
      <div class="subchapter-content">
        {{ $page.Content }}
      </div>
    </section>
    {{- end -}}
    
  {{- end -}}
{{- end -}}

{{/* ========== ARBEITSJOURNAL ========== */}}
{{- with .Site.GetPage "/arbeitsjournal" -}}
<section id="arbeitsjournal" class="arbeitsjournal pdf-section">
  <div class="chapter-title-page">
    <h1 class="chapter-title">{{ .Title }}</h1>
  </div>
  
  {{ with .Content }}
  <div class="section-intro">
    {{ . }}
  </div>
  {{ end }}
  
  {{/* Journal entries sorted by date */}}
  {{- range .Pages.ByDate -}}
  <article class="journal-entry pdf-subsection">
    <header class="journal-header">
      <h3>{{ .Title }}</h3>
      <div class="journal-meta">
        <time>{{ .Date.Format "02.01.2006" }}</time>
        {{ with .Params.arbeitszeit }}
        <span class="arbeitszeit">{{ . }}</span>
        {{ end }}
      </div>
    </header>
    <div class="journal-content">
      {{ .Content }}
    </div>
  </article>
  {{- end -}}
</section>
{{- end -}}

{{/* ========== GLOSSAR ========== */}}
{{- with .Site.GetPage "/glossar" -}}
<section id="glossar" class="glossar pdf-section">
  <div class="chapter-title-page">
    <h1 class="chapter-title">{{ .Title }}</h1>
  </div>
  
  <div class="glossar-content">
    {{- range $key, $value := sort $.Site.Data.glossary "term" -}}
    <div class="glossar-entry" id="glossar-{{ $value.id | urlize }}">
      <dt class="glossar-term">{{ $value.term }}</dt>
      <dd class="glossar-definition">{{ $value.definition }}</dd>
    </div>
    {{- end -}}
  </div>
</section>
{{- end -}}

{{/* ========== MERMAID INITIALIZATION & PRINT READY ========== */}}
<script>
document.addEventListener('DOMContentLoaded', async function() {
  const printBtn = document.getElementById('printBtn');
  const printStatus = document.getElementById('printStatus');
  
  // Initialize Mermaid
  mermaid.initialize({
    startOnLoad: false,
    theme: 'default',
    securityLevel: 'loose',
    flowchart: { useMaxWidth: true, htmlLabels: true },
    sequence: { useMaxWidth: true },
    gantt: { useMaxWidth: true }
  });
  
  try {
    // Find all mermaid diagrams and render them
    const diagrams = document.querySelectorAll('.mermaid');
    
    if (diagrams.length > 0) {
      printStatus.textContent = `Rendere ${diagrams.length} Diagramm(e)...`;
      await mermaid.run({ nodes: diagrams });
    }
    
    // Wait for all images to load
    const images = document.querySelectorAll('img');
    if (images.length > 0) {
      printStatus.textContent = `Lade ${images.length} Bild(er)...`;
      await Promise.all(
        Array.from(images)
          .filter(img => !img.complete)
          .map(img => new Promise(resolve => {
            img.onload = resolve;
            img.onerror = resolve;
          }))
      );
    }
    
    // All ready
    printStatus.textContent = 'âœ“ Bereit zum Drucken';
    printStatus.style.background = '#dae5ec';
    printBtn.disabled = false;
    
  } catch (error) {
    console.error('Rendering error:', error);
    printStatus.textContent = 'âš  Fehler - trotzdem drucken mÃ¶glich';
    printStatus.style.background = '#dae5ec';
    printBtn.disabled = false;
  }
});
</script>

</body>
</html>
